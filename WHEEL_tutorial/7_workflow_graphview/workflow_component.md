## 2. 各コンポーネントのプロパティ説明
この節では、ワークフローの作成に用いる各ワークフローコンポーネントのプロパティについて
説明します。

ワークフローコンポーネントは以下の7種です。  

![img](./img/workflow_componentlibrary.png "workflow_componentlibrary")  

以下で各コンポーネントについて説明します。

### Workflow コンポーネント
![img](./img/workflow.png "workflow")  

Workflowコンポーネントは、複数のコンポーネントからなる処理を一つのコンポーネントにまとめるために用います。  
Workflowコンポーネントを使用することで、ワークフロー編集画面上を処理毎に集約することができ、ワークフロー全体の見通しを良くすることができます。  

Workflowコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 *1 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 *2 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン *2 | 後続コンポーネントへ渡すファイル | 
| clean up flag | ラジオボタン | リモート環境に作成した一時ファイルの取り扱い決定フラグ | 
|  | clean up | 削除する | 
|  | keep files | 削除しない | 
|  | follow parent setting | 親コンポーネントと同じ挙動をする *3 | 

*1 プロパティに使用できる文字列は、半角英数字[0-9 a-Z]、ハイフン[ - ]、アンダースコア[ _ ]のみです。  
　ただし、Descriptionは任意の文字列を使用できます。    
*2 詳細は次節にて説明  
*3 clean up flag の初期値は、[ follow parent setting ]です。  
　ただし、rootワークフロー作成時は、[ clean up ]へ変更します。

### Task コンポーネント
![img](./img/task.png "task")  

Taskコンポーネントは、WHEELの用意するコンポーネントの中で最も基本的かつ重要なコンポーネントです。    
remotehostおよびjobSchedulerの設定に応じてスクリプトの実行、ジョブ投入などの処理が行われます。  

Taskコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 | コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| script | ファイル名 | Task内の処理を記述したスクリプトのファイル名 *1| 
| host | セレクトボックス | Taskを実行するhost、localhostまたは登録済のremotehostのlabelを指定する | 
| useJobScheduler | チェックボックス | scriptをバッチスケジューラ経由で実行するか直接実行するかのフラグ | 
| queue | セレクトボックス | ジョブの投入先キュー(useJobSchedulerを使用しない場合は使われない) | 
| clean up flag | ラジオボタン | リモート環境に作成した一時ファイルの取り扱い指定フラグ | 
|  | clean up | 削除する | 
|  | keep files | 削除しない | 
|  | follow parent setting | 親コンポーネントと同じ挙動をする | 
| include | ファイル名 | リモート環境から回収してくるファイル *2 | 
| exclude | ファイル名 | リモート環境から回収しないファイル *2 | 
| state clean | ボタン | コンポーネントの進行状態を初期状態に戻す *3 | 

*1 scriptに指定されたスクリプトの終了コードが0の場合は真と判定し、後続のノードへ遷移します。  
　それ以外の場合は、偽と判定しプロジェクトの実行を停止します。（プロジェクトの判定はfailedとなります。）  
　ただし、paramterStudyコンポーネントで実行するTaskのみ、後続ノードは継続実行されます。  
*2 include, excludeともにglobパターンを指定することができます。  
　includeにマッチしなおかつexcludeにマッチしないファイルを回収してくることができます。  
　ただし、outputFilesに指定されたファイルは、include/excludeの指定に関わらず全て回収されます。  
*3 コンポーネントの進行状態が"finished"もしくは"failed"の時のみ表示されます。

### ParameterStudy コンポーネント
![img](./img/PS.png "Parameter Study")  

ParameterStudyコンポーネントは、parameter setting fileプロパティに設定されたファイルを読み込み、そのファイルに指定されたパラメータ展開を行います。  
ループ系コンポーネントと同様にディレクトリのコピーを作成します。（ループ系コンポーネントについては後述参照）  
ループ系コンポーネントとは異なり、コピーされた各ディレクトリの処理は並行して行われます。  

ParameterStudyコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| parameter setting file | ファイル名 | パラメータスタディの設定を記述したファイル | 
| state clean | ボタン | コンポーネントの進行状態を初期状態に戻す *1 | 

*1 コンポーネントの進行状態が"finished"もしくは"failed"の時のみ表示されます。

### If コンポーネント
![img](./img/if.png "if")  

Ifコンポーネントは、conditionプロパティに設定された値を評価し、真の場合はnext（緑）に指定されたコンポーネントを  
偽の場合はelse（紫）に指定されたコンポーネントを、後続タスクとして登録して終了します。  

Ifコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| condition | ファイル名,またはJavaScriptの式 | 条件判定を行うスクリプトのファイル名、またはJavaScriptの式 *1 | 
| state clean | ボタン | コンポーネントの進行状態を初期状態に戻す *2 | 

*1 conditionに指定されたスクリプトの終了コードが0の場合は真、それ以外の場合は、偽と判定して後続のノードへ遷移します。  
　(後述のWhileコンポーネントではループ継続となります。)  
　ただし、conditionに指定された文字列と一致するファイルが存在しなかった場合は、Javascriptの式とみなしてそのコードを実行します。  
　この場合、実行結果がtruthyな値の場合を真、falseyな値の場合を偽とします。  
　また、Javascriptの式には、予約済環境変数`$WHEEL_CURRENT_INDEX`（ループ系コンポーネントのループカウンタインデックス）が使用できます。  
*2 コンポーネントの進行状態が"finished"もしくは"failed"の時のみ表示されます。

### ループ系コンポーネント
これより説明するループ系コンポーネント（For, While, Foreach）は、ループカウンタインデックスを環境変数`$WHEEL_CURRENT_INDEX`に持ちます。  
自身と同じ階層に、ループカウンタインデックスの値に応じたsuffixをつけてコンポーネント内に存在する全てのコンポーネントのコピーを作成します。  
生成処理が完了したら、ループカウンタインデックスを進めて終了判定を行い、ループが終了してなければ再度コピーを作成します。  
ループが終了条件を満たした時点で、これらのコンポーネントは終了となります。  
使用法等の詳細については[ワークフローの作成（使用例と実行）](./../9_create_workflow/create_workflow.md)`ループ系コンポーネント`をご確認ください。  

### For コンポーネント
![img](./img/for.png "for")  

Forコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| start | 整数値 | ループの始値 | 
| end | 整数値 | ループの終値 | 
| step | 整数値 | 1回のループでのインデックスの増分（負値も可）| 
| state clean | ボタン | コンポーネントの進行状態を初期状態に戻す *1 | 

*1 コンポーネントの進行状態が"finished"もしくは"failed"の時のみ表示されます。

### While コンポーネント
![img](./img/while.png "while")  

Whileコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| condition | ファイル名,またはJavaScriptの式 | 条件判定を行うスクリプトのファイル名、またはJavaScriptの式 *1 | 
| state clean | ボタン | コンポーネントの進行状態を初期状態に戻す *2 | 

*1 conditionは、スクリプトの実行前に評価されます。  
　その他conditionの取り扱いは `Ifコンポーネント` をご確認ください。  
*2 コンポーネントの進行状態が"finished"もしくは"failed"の時のみ表示されます。  

### Foreach コンポーネント
![img](./img/foreach.png "foreach")  

Foreachコンポーネントのプロパティは以下です。

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| indexList | 文字列 | ループインデックスに指定される値のリスト *1| 
| state clean | ボタン | コンポーネントの進行状態を初期状態に戻す *2 | 

*1 使用できる文字列は`Workflowコンポーネント`をご確認ください。  
*2 コンポーネントの進行状態が"finished"もしくは"failed"の時のみ表示されます。

### Source コンポーネント
![img](./img/source.png "source")    

Sourceコンポーネントは、実際のプロジェクト実行に先立ちoutputFileプロパティに指定されたファイルの実体を用意する処理を行います。  
uploadOnDemandフラグが指定されている場合は、クライアントにファイルのアップロードを要求します。  
コンポーネントディレクトリ内に、cmp.wheel.json以外のファイルが複数存在した場合は、どのファイルを使うかをクライアントに指定させます。  
また、cmp.wheel.json以外にファイルが存在しなかった場合は、クライアントにファイルのアップロードを要求します。  

Sourceコンポーネントのプロパティは以下です。  

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| outputFiles | ファイル, ディレクトリ名またはglobパターン | 後続コンポーネントへ渡すファイル | 
| uploadOnDemand | チェックボックス | プロジェクト実行開始時にクライアントからアップロードさせるかどうかのフラグ | 

### Viewer コンポーネント
![img](./img/viewer.png "viewer")  

Viewerコンポーネントは、結果ファイルを収集するために使用します。  
inputFilesに指定されたファイルを先行コンポーネントから受け取った後、ブラウザにて表示な可能なファイル（画像ファイル）が存在する場合は、別タブを起動し表示します。

Viewerコンポーネントのプロパティは以下です。  

| プロパティ | 入力値 | プロパティ説明 |
|----|----|----|
| name | 文字列 |  コンポーネントのディレクトリ名 |
| description | 文字列 | コンポーネントの説明文 | 
| inputFiles | ファイルまたはディレクトリ名 | 先行コンポーネントから受け取るファイル *1 | 

*1 ファイル形式は画像ファイル（拡張子png, jpg, gif, bmp）をサポートしています。  

## 3. コンポーネントプロパティの仕様詳細

## inputFileおよびoutputFile   
前節に示したコンポーネントのinputFiles, outputFilesに設定可能な入力値について説明します。　　

inputFiles, outputFilesには以下の4種類の文字列を指定することができます。  
・空文字列(inputのみ)  
・path.sep('\\'でも'/'でも良い)を含む文字列  
・path.sep('\\'でも'/'でも良い)を含まない文字列  
・globパターン(outputのみ)  

### inputが空文字列の場合  
inputは後続ノードのrootディレクトリ(そのノードのpathプロパティが指定されたディレクトリ)が指定されてものとして扱われます。  

### inputがpath.sepを含まない文字列の場合  
outputが単一のファイルの場合、inputはファイル名として扱われ、別名でのシンボリックリンクが作成されます。  
outputがディレクトリの場合、inputはディレクトリ名として扱われ、その名前でディレクトリへのシンボリックリンクが作成されます。  
outputがglobパターンの場合、inputはディレクトリ名として扱われ、そのディレクトリの下にglobパターンで指定されたファイルへのシンボリックリンクが作成されます。  
いずれの場合でも、outputの指定文字列にpath.sepが含まれた場合は後続ノード側でも同じディレクトリが作成された上でシンボリックリンクが作成されます。  

### inputがpath.sepを含む文字列の場合  
最後のpath.sepまでを後続ノードのrootディレクトリからの相対ディレクトリ名として扱います。  
先頭と末尾のpath.sepは無視され、それぞれ取り除いた値が指定されたものとして扱います。  
例えば'/foo/bar/'という指定がされた場合は、'foo/bar'が指定されたものとして扱います。  
(もしあれば)末尾のものを除いて最後のpath.sep以降に続く文字列は"inputがpath.sepを含まない文字列の場合"に準じてoutputの指定に応じた取り扱いを行います。    

## コンポーネントディレクトリへのファイル操作
コンポーネントで使用するファイルは、コンポーネント選択時に表示されるプロパティ画面の[ Files ]領域より設定します。  

例：Workflowコンポーネントのプロパティ画面  

![img](./img/property_Files.png "property_Files")  

Files領域の構成は、以下です。  

![img](./img/Files.png "Files")  

1. rootワークフローからの相対パス表示領域
1. JupyterNotebookの起動ボタン
1. コンポーネントディレクトリへの新規ディレクトリの作成ボタン
1. コンポーネントディレクトリへの新規ファイルの作成ボタン
1. コンポーネントディレクトリへのファイルのアップロードボタン（ファイルブラウザの起動）
1. ファイル編集ボタン
1. PS用ファイル編集ボタン

以下で各ボタンの機能について説明します。

### コンポーネントディレクトリへの新規ディレクトリの作成
コンポーネントディレクトリへの新規ディレクトリの作成手順は以下になります。

1. 新規ディレクトリを作成したいコンポーネントをクリックする。
1. [ Files ]領域内の上記Files領域図ボタン「3」をクリックする。
1. 表示されるダイアログより、作成するディレクトリ名を入力し、[ OK ]ボタンをクリックする。

##### 新規ディレクトリの作成  

![img](./img/create_directory.png "create_directory")  

##### 作成結果 

![img](./img/create_directory_result.png "create_directory_result")  

### コンポーネントディレクトリへの新規ファイルの作成
新規ファイルの作成もディレクトリの作成と同様に以下の手順になります。

1. 新規ファイルを作成したいコンポーネントをクリックする。
1. [ Files ]領域内の上記Files領域図ボタン「4」をクリックする。
1. 表示されるダイアログより、作成するファイル名を入力し、[ OK ]ボタンをクリックする。

### コンポーネントディレクトリへのファイルのアップロード

コンポーネントディレクトリへのファイルのアップロード手順は以下になります。

1. 新規ディレクトリを作成したいコンポーネントをクリックする。
1. [ Files ]領域内の上記Files領域図ボタン「5」をクリックする。
1. 表示されるファイルブラウザ画面、アップロードしたいファイルを選択し、[ 開く ]ボタンをクリックする。

##### ファイルのアップロード 

![img](./img/file_upload.png "file_upload")  

##### アップロード結果 

![img](./img/file_upload_result.png "file_upload_result")  

## 階層間（親子間）のファイル移動    
Workflow, ParameterStudy, 及びループ系（For, While, Foreach）のコンポーネントは、  
コンポーネント内にコンポーネント（子コンポーネント）を持つことができます。  
親コンポーネントから子コンポーネントへのファイル移動は、親子間ファイル移動機能を使用することで行うことができます。  
使用方法は以下です。  

### 親階層から子階層へ
1. 渡し元コンポーネント（task0）の出力ファイルを設定する（図1参照）
1. 渡し先コンポーネント（workflow0）の入力ファイル名を設定する
1. 渡し元コンポーネント（task0）の出力ファイルを渡し元コンポーネント（workflow0）の入力ファイルへ接続する
1. コンポーネントの子階層へ遷移する（図2参照）
1. 子階層にてコンポーネントを作成する（childTask）
1. 子コンポーネント（childTask）の入力ファイルを設定する
1. 親コンポーネントからの入力ファイルを子コンポーネント（childTask）の入力ファイルへ接続する  

##### 図1 コンポーネントの出力・入力ファイル設定（親階層から子階層へ）
![img](./img/move_file_PtoC.png "入出力ファイルの設定")  

##### 図2 親から子へのファイル転送
![img](./img/PtoC_file_connection.png "親子間ファイルの接続")  


### 子階層から親階層へ
1. 渡し元コンポーネント（workflow0）の出力ファイルを設定する（図3参照）
1. 渡し先コンポーネント（task1）の入力ファイル名を設定する
1. 渡し元コンポーネント（workflow0）の出力ファイルを渡し先コンポーネント（task1）の入力ファイルへ接続する
1. コンポーネントの子階層へ遷移する（図4参照）
1. 子コンポーネント（childTask）の出力ファイルを設定する
1. 子コンポーネント（childTask）の出力ファイルを親コンポーネントの出力ファイルへ接続する

##### 図3 コンポーネントの出力・入力ファイル設定（子階層から親階層へ）
![img](./img/move_file_CtoP.png "入出力ファイルの設定")  

##### 図4 子から親へのファイル転送
![img](./img/CtoP_file_connection.png "親子間ファイルの接続")  

ただし、子階層において親の入力ファイルを直接出力ファイルへ渡すこと（input1.txtをoutput2.txtへ接続する　図4参照）はできません。   