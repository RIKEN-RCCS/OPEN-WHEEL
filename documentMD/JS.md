# はじめに
本ドキュメントは、WHEELが使用する設定ファイルのうち、jobScheduler.jsonファイルの設定値と
ソース内での参照方法について定義するものです。

# jobScheduler.jsonファイルの構造
jobScheduler.jsonファイルのトップレベルには単一のオブジェクトのみを置くことができる。

トップレベルのオブジェクト内には、ジョブスケジューラの設定名をキーとし、各ジョブスケジューラで用いるコマンド等を記述したオブジェクトを値とするオブジェクトを複数置くことができる。

各ジョブスケジューラの設定を記述したオブジェクトには次のプロパティを含める必要がある

- submit
- queueOpt
- grpName
- stat
- del
- reJobID
- reFinishedState
- reReturnCode
- reJobStatusCode
- acceptableRt


statは文字列または文字列の配列、
acceptableRtは数値または数値の配列、
それ以外の各プロパティは文字列型の値を持ち、
それぞれの意味は次のとおりである

## submit
ジョブ投入時に用いるコマンド名および必須のオプションを指定する。
ただし、後述のqueueOptやgrpNameで指定する値は含めないこと

## queueOpt
投入先キューを指定するためのオプションを指定する。

## grpName
UGEで使われるグループ名を指定するためのオプションを指定する

submit, queueOpt, grpNameが全て指定された状態で、あるtaskコンポーネントのジョブを
投入する時には、実際に使われるコマンドは次の文字列になる。

`${submit} ${grpName} ${task.queue} ${queueOpt}${task.queue} ./${task.script}`


## reJobID
ジョブ投入コマンドが返す文字列から投入したジョブのIDを取得するための正規表現
この正規表現に含まれる最初のキャプチャがジョブIDとして扱われる。

指定された文字列は、そのままRegExpのコンストラクタに渡されるので、
必要に応じてエスケープする必要がある。
なお、この規定は他の正規表現を指定する文字列全てにもあてはまる

## stat
ジョブのステータス確認に使われるコマンドをオプションも含めて指定する

値として文字列が指定された場合は、その後にjobIDをつけて1回実行するが、
文字列の配列が指定された場合は、配列の各要素に対してjobIDをつけ、
正常終了するまで順番にコマンドを実行する。

例えば、設定値が["stat -a", "stat -b"]の時は

`stat -a ${jobID} || stat -b ${jobID}`

という形で実行され、`stat -a`が成功すればその出力を、`stat -a`が非0を返した時は`stat -b`の出力をstatコマンドの出力として扱う

## reFinishedState
ステータス確認コマンドが返す文字列に対して、ジョブが終了したかどうか
(これ以上status checkを行なわなくても良いかどうか)を判定するための正規表現

正常終了か異常終了かの判定は、後述のreReturnCodeやreJobStatusCodeが返すキャプチャを元に判定する

## reReturnCode
statコマンドの出力から、ジョブスクリプトの戻り値(exit code)を取得するための正規表現
この正規表現に含まれる唯一のキャプチャの値を戻り値として扱うが、正規表現に該当しない
またはキャプチャが何も含まない時は "-2" で上書きする(ログには上書きしたと出力される)

## reJobStatus
statコマンドの出力から、ジョブスケジューラが返すステータスコードを取得するための正規表現
この正規表現に含まれる唯一のキャプチャの値を戻り値として扱うが、正規表現に該当しない
またはキャプチャが何も含まない時は "-2" で上書きする(ログには上書きしたと出力される)

statの仕様変更にともなって、reFinishedState, reReturnCode, reJobStatusの仕様も変更される可能性が高い

## del
ジョブの削除に使われるコマンドを、オプションも含めて指定する。
引数にjobIDを取る形で呼ばれる

## acceptableRt
statコマンド実行時の戻り値として、0以外に許容する値を指定する。
複数の戻り値を許容する時は、数値の配列として指定する。

本プロパティはオプションであり未指定でも問題無く動作する。

本プロパティが指定されている場合、ジョブスクリプトの戻り値は取得せず、正常終了したものと仮定して扱われるため、必要に応じて後続のコンポーネント等で状況を確認する必要がある

# 動作確認情報
配布物に含まれるjobSchduler.jsonの設定は次の環境で動作確認を行なっている。

- PBSPro, PBSProWithoutHistory  -> PBSPro(Open source版) ver. 18
- SLURM -> SLURM 17.02.10
- Fugaku -> 2021/2/12 時点の富岳

