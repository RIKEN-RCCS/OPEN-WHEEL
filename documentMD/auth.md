本ドキュメントは、WHEELに2024年度から導入された認証機構に関して記述したものです。

WHEELの認証機構は、passport-localモジュールを用いてDBに登録済のユーザが正しいパスワードを入力した時のみ
WHEELの各画面(home, remotehost, workflow, viewer)へのアクセスを許すという単純なものです。


## 認証機構の利用方法
認証機構はデフォルトでは無効になっており、起動時に環境変数 `WHEEL_ENABLE_AUTH` に何かの値が設定されている時のみ
有効になります。

## 認証機構の詳細
認証機構が有効な場合、WHEELサーバのhttp(s)でのアクセスは全て login ページへリダイレクトされます。

loginページで入力したユーザ/パスワードがユーザDB内に存在するユーザと一致した場合、そのsessionはログイン済とみなし
それ以降のアクセスではログインを要求せず各ページにアクセスすることができます。

なお、ブラウザ画面から新規ユーザを登録するいわゆるサインアップ機構や、一旦認証したブラウザを未認証状態に戻すログアウト機能は
提供されません。また、パスワードに使用可能な文字数、文字種等の制限もなくログイン機能に対するbrute force attackの対策も無いなど
本認証機構は非常に簡易的なものですので、WANでの運用にあたっては別途リバースプロキシ等を用意してそちらで認証を行なうことを強く推奨します。


## ユーザDB
DBはWHEEL serverのインストールディレクトリ配下の次のパスに置かれたsqliteのファイルを用います。

```
app/db/user.db
```

DBのメンテナンス用のツールとして、bin/passwordDBTool.js が用意されています。
本ツールはnode.js用のjavascriptファイルなので、次のコマンドで実行してください。

```
node bin/passwordDBTool.js
```

オプション無しで起動した場合は、DB内に登録されているユーザ名の一覧を表示します。
それ以外の利用方法は次のとおりです。

### ユーザの追加
次のコマンドで、ユーザ (foo)、 パスワード (bar) をDBに登録します

```
node bin/passwordDBTool.js -u foo -p bar
```

### ユーザの削除
次のコマンドで既存のユーザ(foo)をDBから削除します

```
node bin/passwordDBTool.js -d -u foo
```


### アノニマスユーザの作成
次のコマンドでアノニマスユーザを作成します。
既にDB内に存在する場合は、新規パスワードを発行します。

```
node bin/passwordDBTool.js -A
```

正常にアノニマスユーザが作成されると、画面に次のようにパスワードが出力されます。

```
Anonymous user created with password =  XXXXXXXXXXXX
```

ログイン時には、ユーザ名として `anonymous` パスワードとして上記出力中の "XXXXXXXXXXXX" を入力してください。


### DBの全削除
次のコマンドを実行するとDBのファイルが削除されます。

```
node bin/passwordDBTool.js -c
```

本処理は、ユーザの追加やアノニマスユーザの作成と同時に行なうことができます。
例えば `-A -c` オプションを指定すると、DBを一旦削除して空のユーザDBに新規にアノニマスユーザのみを追加します。



## docker版起動時のアノニマスユーザ作成方法
docker版wheelの起動時に環境変数 `WHEEL_ANONYMOUS_LOGIN="YES"` が指定されていると
認証機構が有効になり、起動中に新規にアノニマスユーザが作成されます。(パスワードは起動ログ中に出力されます)

この方法で起動した場合、パスワードは平文でログファイル内に保存される可能性があるので
パスワード出力部のみ通常のログ出力とは分けるなど、取扱には十分に留意してください。
